name: Decompile Diff Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  decompile-diff:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Build azoth CLI
        run: cargo build --bin azoth --release

      - name: Run decompile-diff analysis
        id: analysis
        run: |
          DEPLOYMENT="examples/escrow-bytecode/artifacts/deployment_bytecode.hex"
          RUNTIME="examples/escrow-bytecode/artifacts/runtime_bytecode.hex"

          if [[ ! -f "$DEPLOYMENT" ]] || [[ ! -f "$RUNTIME" ]]; then
            echo "::error::Bytecode artifacts not found"
            exit 1
          fi

          # Run decompile-diff and capture output
          OUTPUT=$(./target/release/azoth decompile-diff \
            "$DEPLOYMENT" \
            --runtime "$RUNTIME" \
            --passes "" \
            --iterations 50 \
            --top-replacements 3 2>&1) || true

          # Save output to file for the comment
          echo "$OUTPUT" > decompile-diff-output.txt

          # Extract key metrics for summary
          HUNKS_AVG=$(echo "$OUTPUT" | grep "^Hunks" | awk '{print $3}')
          LINES_REMOVED_AVG=$(echo "$OUTPUT" | grep "^Lines removed" | awk '{print $3}')
          LINES_ADDED_AVG=$(echo "$OUTPUT" | grep "^Lines added" | awk '{print $3}')

          echo "hunks_avg=${HUNKS_AVG:-N/A}" >> "$GITHUB_OUTPUT"
          echo "lines_removed_avg=${LINES_REMOVED_AVG:-N/A}" >> "$GITHUB_OUTPUT"
          echo "lines_added_avg=${LINES_ADDED_AVG:-N/A}" >> "$GITHUB_OUTPUT"

      - name: Create or update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('decompile-diff-output.txt', 'utf8');

            const commentMarker = '<!-- decompile-diff-analysis -->';
            const body = `${commentMarker}
            ## Decompile Diff Analysis

            This analysis compares decompiled output before and after obfuscation to measure transform effectiveness.

            <details>
            <summary><b>Quick Summary</b></summary>

            | Metric | Average |
            |--------|---------|
            | Hunks | ${{ steps.analysis.outputs.hunks_avg }} |
            | Lines Removed | ${{ steps.analysis.outputs.lines_removed_avg }} |
            | Lines Added | ${{ steps.analysis.outputs.lines_added_avg }} |

            </details>

            <details>
            <summary><b>Full Analysis Output</b></summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>

            ---
            <sub>Generated by decompile-diff analysis on commit ${{ github.event.pull_request.head.sha.substring(0, 7) }}</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c => c.body.includes(commentMarker));

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body,
              });
              console.log(`Updated existing comment ${existingComment.id}`);
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
              console.log('Created new comment');
            }
